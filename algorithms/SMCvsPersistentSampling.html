
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Comparing SMC and Persistent Sampling &#8212; The Sampling Book Project</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'algorithms/SMCvsPersistentSampling';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Microcanonical Langevin Monte Carlo" href="mclmc.html" />
    <link rel="prev" title="Tuning inner kernel parameters of SMC" href="TemperedSMCWithOptimizedInnerKernel.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">The Sampling Book Project</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    The Sampling Book Project
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Algorithms</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="contour_sgld.html">Contour stochastic gradient Langevin dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="cyclical_sgld.html">Cyclical SGLD</a></li>
<li class="toctree-l1"><a class="reference internal" href="pathfinder.html">Pathfinder</a></li>
<li class="toctree-l1"><a class="reference internal" href="PeriodicOrbitalMCMC.html">Periodic Orbital MCMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="TemperedSMC.html">Use Tempered SMC to Improve Exploration of MCMC Methods.</a></li>
<li class="toctree-l1"><a class="reference internal" href="TemperedSMCWithOptimizedInnerKernel.html">Tuning inner kernel parameters of SMC</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Comparing SMC and Persistent Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="mclmc.html">Microcanonical Langevin Monte Carlo</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Models</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../models/change_of_variable_hmc.html">Change of Variable in HMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/GP_EllipticalSliceSampler.html">Gaussian Regression with the Elliptical Slice Sampler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/GP_Marginal.html">Bayesian Regression With Latent Gaussian Sampler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/sparse_regression.html">Sparse regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/logistic_regression.html">Bayesian Logistic Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/LogisticRegressionWithLatentGaussianSampler.html">Bayesian Logistic Regression With Latent Gaussian Sampler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/mlp.html">MLP classifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/hierarchical_bnn.html">Hierarchical Bayesian Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/RegimeSwitchingModel.html">Regime switching Hidden Markov model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/probabilistic_ode_solver_parameter_estimation.html">Parameter estimation in ODE models with a probabilistic ODE solver</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/blackjax-devs/sampling-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/blackjax-devs/sampling-book/issues/new?title=Issue%20on%20page%20%2Falgorithms/SMCvsPersistentSampling.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/algorithms/SMCvsPersistentSampling.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Comparing SMC and Persistent Sampling</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sequential-monte-carlo-smc">Sequential Monte Carlo (SMC)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#persistent-sampling-ps">Persistent Sampling (PS)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-and-settings">Imports and Settings</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experimental-setup">Experimental Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#smc-with-fixed-schedule">SMC with Fixed Schedule</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#persistent-sampling-with-fixed-schedule">Persistent Sampling with Fixed Schedule</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-smc">Adaptive SMC</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-persistent-sampling">Adaptive Persistent Sampling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#posterior-comparison">9. Posterior Comparison</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="comparing-smc-and-persistent-sampling">
<h1>Comparing SMC and Persistent Sampling<a class="headerlink" href="#comparing-smc-and-persistent-sampling" title="Link to this heading">#</a></h1>
<p>This notebook extends the <code class="docutils literal notranslate"><span class="pre">Use</span> <span class="pre">Tempered</span> <span class="pre">SMC</span> <span class="pre">to</span> <span class="pre">Improve</span> <span class="pre">Exploration</span> <span class="pre">of</span> <span class="pre">MCMC</span> <span class="pre">Methods</span></code> and <code class="docutils literal notranslate"><span class="pre">Tuning</span> <span class="pre">inner</span> <span class="pre">kernel</span> <span class="pre">parameters</span> <span class="pre">of</span> <span class="pre">SMC</span></code>, exploring the theory and implementation of Persistent Sampling (PS) as described in Karamanis et al. (2025), and comparing it with standard tempered Sequential Monte Carlo (SMC) methods. We will compare four different methods:</p>
<ul class="simple">
<li><p>SMC with a fixed tempering schedule</p></li>
<li><p>PS with a fixed tempering schedule</p></li>
<li><p>SMC with an adaptive tempering schedule</p></li>
<li><p>PS with an adaptive tempering schedule</p></li>
</ul>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<section id="sequential-monte-carlo-smc">
<h3>Sequential Monte Carlo (SMC)<a class="headerlink" href="#sequential-monte-carlo-smc" title="Link to this heading">#</a></h3>
<p>SMC samplers propagate N particles through a sequence of probability distributions <span class="math notranslate nohighlight">\(p_t(\theta)\)</span> for <span class="math notranslate nohighlight">\(t = 1, \ldots, T\)</span>, using three main steps:</p>
<ol class="arabic simple">
<li><p><strong>Reweighting</strong>: Adjust particle weights using importance sampling</p></li>
<li><p><strong>Resampling</strong>: Discard low-weight particles and replicate high-weight ones</p></li>
<li><p><strong>Moving</strong>: Apply MCMC steps to diversify particles</p></li>
</ol>
<p>For Bayesian inference with temperature annealing:
$<span class="math notranslate nohighlight">\(p_t(\theta) = \frac{\mathcal{L}(\theta)^{\beta_t} \pi(\theta)}{Z_t}\)</span>$</p>
<p>where <span class="math notranslate nohighlight">\(0 = \beta_1 &lt; \cdots &lt; \beta_T = 1\)</span> interpolates between prior <span class="math notranslate nohighlight">\(\pi(\theta)\)</span> and posterior.</p>
</section>
<section id="persistent-sampling-ps">
<h3>Persistent Sampling (PS)<a class="headerlink" href="#persistent-sampling-ps" title="Link to this heading">#</a></h3>
<p>PS extends SMC by <strong>retaining and reusing particles from all prior iterations</strong>, constructing a growing weighted ensemble. Key differences:</p>
<p><strong>Mixture Distribution</strong>: At iteration <span class="math notranslate nohighlight">\(t\)</span>, particles from previous iterations are treated as samples from:
$<span class="math notranslate nohighlight">\(\tilde{p}_t(\theta) = \frac{1}{t-1} \sum_{s=1}^{t-1} p_s(\theta)\)</span>$</p>
<p><strong>Persistent Weights</strong>: Using multiple importance sampling, weights for particle <span class="math notranslate nohighlight">\(\theta^i_{t'}\)</span> at iteration <span class="math notranslate nohighlight">\(t\)</span> are:
$<span class="math notranslate nohighlight">\(W^i_{tt'} = \frac{\mathcal{L}(\theta^i_{t'})^{\beta_t}}{\frac{1}{t-1}\sum_{s=1}^{t-1} \mathcal{L}(\theta^i_{t'})^{\beta_s}/\hat{Z}_s} \cdot \frac{1}{\hat{Z}_t}\)</span>$</p>
<p><strong>Resampling</strong>: N particles are resampled from <span class="math notranslate nohighlight">\((t-1) \times N\)</span> persistent particles</p>
<p><strong>Key Advantages</strong>:</p>
<ul class="simple">
<li><p>Reduced particle correlation after resampling</p></li>
<li><p>Lower variance estimates for marginal likelihood <span class="math notranslate nohighlight">\(Z\)</span></p></li>
<li><p>Lower variance when calculating expectations
$<span class="math notranslate nohighlight">\( \hat{f} = \sum_{t^\prime}^T \sum_{i}^N W^i_{T{t^\prime}} f(\theta^i_{t^\prime}) \)</span>$</p></li>
</ul>
<p><strong>Trade-offs</strong>:</p>
<ul class="simple">
<li><p>Introduces small bias (proven to be consistent)</p></li>
<li><p>Higher memory footprint (stores all particles)</p></li>
<li><p>More arithmetic operations per iteration</p></li>
</ul>
</section>
</section>
<section id="imports-and-settings">
<h2>Imports and Settings<a class="headerlink" href="#imports-and-settings" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax.scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">multivariate_normal</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">blackjax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">blackjax.smc.resampling</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">resampling</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">blackjax.smc</span><span class="w"> </span><span class="kn">import</span> <span class="n">extend_params</span>

<span class="c1"># Set random seed for reproducibility</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">20251023</span><span class="p">)</span>


<span class="c1"># Plot settings</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="experimental-setup">
<h2>Experimental Setup<a class="headerlink" href="#experimental-setup" title="Link to this heading">#</a></h2>
<p>We will use the same setup as in <code class="docutils literal notranslate"><span class="pre">Use</span> <span class="pre">Tempered</span> <span class="pre">SMC</span> <span class="pre">to</span> <span class="pre">Improve</span> <span class="pre">Exploration</span> <span class="pre">of</span> <span class="pre">MCMC</span> <span class="pre">Methods</span></code>. We have seen that SMC can efficiently sample from a multimodal distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define target distribution</span>
<span class="k">def</span><span class="w"> </span><span class="nf">V</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Potential for two-mode distribution.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">log_likelihood_fn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log likelihood function.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">V</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">log_prior_fn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log prior function.&quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">multivariate_normal</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">d</span><span class="p">,)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">log_posterior_fn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log posterior function, the target distribution.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">log_likelihood_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">log_prior_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HMC parameters</span>
<span class="n">hmc_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">step_size</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
    <span class="n">inverse_mass_matrix</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">num_integration_steps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1"># Initialize particles for the samplers</span>
<span class="n">num_particles</span> <span class="o">=</span> <span class="mi">10_000</span>
<span class="n">initial_particles</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">num_particles</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="smc-with-fixed-schedule">
<h2>SMC with Fixed Schedule<a class="headerlink" href="#smc-with-fixed-schedule" title="Link to this heading">#</a></h2>
<p>Now weâ€™ll run standard SMC with a fixed tempering schedule. The tempering schedule and inference loop can be reused for PS.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tempering schedule</span>
<span class="n">tempering_schedule</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>


<span class="c1"># Inference loop for a fixed schedule</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fixed_schedule_loop</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">,</span> <span class="n">tempering_schedule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run SMC/PS with a fixed tempering schedule.&quot;&quot;&quot;</span>

    <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">one_step</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">lmbda</span><span class="p">):</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">carry</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">lmbda</span><span class="p">)</span>
        <span class="c1"># Return weights history for marginal likelihood computation</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="kc">None</span>

    <span class="p">(</span><span class="n">final_state</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">weights_history</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
        <span class="n">one_step</span><span class="p">,</span>
        <span class="p">(</span><span class="n">initial_state</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">),</span>
        <span class="n">tempering_schedule</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">final_state</span><span class="p">,</span> <span class="n">weights_history</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="c1"># Initialize SMC sampler</span>
<span class="n">smc_sampler</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">tempered_smc</span><span class="p">(</span>
    <span class="n">log_prior_fn</span><span class="p">,</span>
    <span class="n">log_likelihood_fn</span><span class="p">,</span>
    <span class="n">blackjax</span><span class="o">.</span><span class="n">hmc</span><span class="o">.</span><span class="n">build_kernel</span><span class="p">(),</span>
    <span class="n">blackjax</span><span class="o">.</span><span class="n">hmc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="n">extend_params</span><span class="p">(</span><span class="n">hmc_parameters</span><span class="p">),</span>
    <span class="n">resampling</span><span class="o">.</span><span class="n">systematic</span><span class="p">,</span>
    <span class="n">num_mcmc_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Run SMC with fixed schedule</span>
<span class="n">key</span><span class="p">,</span> <span class="n">smc_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">smc_initial_state</span> <span class="o">=</span> <span class="n">smc_sampler</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">initial_particles</span><span class="p">)</span>
<span class="n">smc_final_state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fixed_schedule_loop</span><span class="p">(</span>
    <span class="n">smc_key</span><span class="p">,</span>
    <span class="n">smc_sampler</span><span class="p">,</span>
    <span class="n">smc_initial_state</span><span class="p">,</span>
    <span class="n">tempering_schedule</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">smc_final_weights</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">smc_final_state</span><span class="o">.</span><span class="n">weights</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">smc_final_state</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final ESS (SMC): </span><span class="si">{</span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">smc_final_weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Final ESS (SMC): 9991.73

CPU times: user 5.41 s, sys: 2.12 s, total: 7.53 s
Wall time: 2.52 s
</pre></div>
</div>
</div>
</div>
</section>
<section id="persistent-sampling-with-fixed-schedule">
<h2>Persistent Sampling with Fixed Schedule<a class="headerlink" href="#persistent-sampling-with-fixed-schedule" title="Link to this heading">#</a></h2>
<p>Now we run the same loop for the persistent sampling. Note that there are a few conditions and caveats for Persistent Sampling to function correctly:</p>
<ul class="simple">
<li><p>For the reweighting scheme to work correctly, the prior density must be normalised to 1.</p></li>
<li><p>Related to the statement above, the tempering schedule must start at 0. Together with the normalised prior, this guarantees that <span class="math notranslate nohighlight">\(Z_0 = 1\)</span>. Internally, this is enforced by adding a 0.0 to the beginning of the tempering schedule.</p></li>
<li><p>To keep track of the persistent particles in a JIT-compatible way, all arrays in the PSState must be padded to the length of the tempering schedule (+1 to account for the added 0.0 mentioned above). The values get filled in with each iteration of the sampler. For this reason, the <code class="docutils literal notranslate"><span class="pre">persistent_sampling_smc</span></code> requires an <code class="docutils literal notranslate"><span class="pre">n_schedule</span></code> which MUST match the length of the tempering schedule. This can lead to highly increased memory usage for long tempering schedules.</p></li>
<li><p>The padding is done internally when calling the <code class="docutils literal notranslate"><span class="pre">init</span></code> function. The padding value is 0.</p></li>
<li><p>The weights returned by <code class="docutils literal notranslate"><span class="pre">ps_final_state.persistent</span> <span class="pre">weights</span></code> are normalised to sum to (<span class="math notranslate nohighlight">\(i \cdot N\)</span>). This is the appropriate normalization to calculate expectations values as defined in the introduction. However, to calculate the effective sample size using the common <span class="math notranslate nohighlight">\(\sum \frac{1}{W^2}\)</span> equation, they first need to be normalized to 1.</p></li>
</ul>
<p>Finally, the effective sample size of the final persistent ensemble can (and ideally will) be much larger than the number of particles per iteration.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="c1"># Initialize Persistent Sampling</span>
<span class="n">ps_sampler</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">persistent_sampling_smc</span><span class="p">(</span>
    <span class="n">log_prior_fn</span><span class="p">,</span>
    <span class="n">log_likelihood_fn</span><span class="p">,</span>
    <span class="n">tempering_schedule</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">blackjax</span><span class="o">.</span><span class="n">hmc</span><span class="o">.</span><span class="n">build_kernel</span><span class="p">(),</span>
    <span class="n">blackjax</span><span class="o">.</span><span class="n">hmc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="n">extend_params</span><span class="p">(</span><span class="n">hmc_parameters</span><span class="p">),</span>
    <span class="n">resampling</span><span class="o">.</span><span class="n">systematic</span><span class="p">,</span>
    <span class="n">num_mcmc_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Run Persistent Sampling with fixed schedule</span>
<span class="n">key</span><span class="p">,</span> <span class="n">ps_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">ps_initial_state</span> <span class="o">=</span> <span class="n">ps_sampler</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">initial_particles</span><span class="p">)</span>
<span class="n">ps_final_state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fixed_schedule_loop</span><span class="p">(</span>
    <span class="n">ps_key</span><span class="p">,</span>
    <span class="n">ps_sampler</span><span class="p">,</span>
    <span class="n">ps_initial_state</span><span class="p">,</span>
    <span class="n">tempering_schedule</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ps_final_weights</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ps_final_state</span><span class="o">.</span><span class="n">persistent_weights</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ps_final_state</span><span class="o">.</span><span class="n">persistent_weights</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final ESS (Persistent Sampling): </span><span class="si">{</span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ps_final_weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Final ESS (Persistent Sampling): 236969.00 

CPU times: user 8.78 s, sys: 4.64 s, total: 13.4 s
Wall time: 4.59 s
</pre></div>
</div>
</div>
</div>
</section>
<section id="adaptive-smc">
<h2>Adaptive SMC<a class="headerlink" href="#adaptive-smc" title="Link to this heading">#</a></h2>
<p>Now we run the adaptive algorithms where the tempering schedule is chosen automatically. For the adaptive algorithm inference loop, we use a while loop that terminates when a tempering paramter of 1 is reached, or a predefined number of iterations is exceeded.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">adaptive_schedule_loop</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">,</span> <span class="n">max_iterations</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run adaptive SMC until condition is met.&quot;&quot;&quot;</span>

    <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">one_step</span><span class="p">(</span><span class="n">carry</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">carry</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">key</span>

    <span class="n">n_iter</span><span class="p">,</span> <span class="n">final_state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span>
        <span class="n">cond</span><span class="p">,</span>
        <span class="n">one_step</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">n_iter</span> <span class="o">&gt;=</span> <span class="n">max_iterations</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Warning: Maximum number of iterations reached before lambda=1.0, &quot;</span>
            <span class="s2">&quot;the final state may not represent the target distribution. &quot;</span>
            <span class="s2">&quot;Check the final tempering parameter value.&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">n_iter</span><span class="p">,</span> <span class="n">final_state</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">target_ess</span> <span class="o">=</span> <span class="mf">0.95</span>

<span class="c1"># Initialize Adaptive SMC sampler</span>
<span class="n">adaptive_smc_sampler</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">adaptive_tempered_smc</span><span class="p">(</span>
    <span class="n">log_prior_fn</span><span class="p">,</span>
    <span class="n">log_likelihood_fn</span><span class="p">,</span>
    <span class="n">blackjax</span><span class="o">.</span><span class="n">hmc</span><span class="o">.</span><span class="n">build_kernel</span><span class="p">(),</span>
    <span class="n">blackjax</span><span class="o">.</span><span class="n">hmc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="n">extend_params</span><span class="p">(</span><span class="n">hmc_parameters</span><span class="p">),</span>
    <span class="n">resampling</span><span class="o">.</span><span class="n">systematic</span><span class="p">,</span>
    <span class="n">target_ess</span><span class="o">=</span><span class="n">target_ess</span><span class="p">,</span>
    <span class="n">num_mcmc_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Define condition function for Adaptive SMC</span>
<span class="k">def</span><span class="w"> </span><span class="nf">smc_cond</span><span class="p">(</span><span class="n">carry</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns True while lambda &lt; 1.0 and iteration &lt; max_iterations.&quot;&quot;&quot;</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">carry</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">tempering_param</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_iterations</span><span class="p">)</span>

<span class="c1"># Run Adaptive SMC</span>
<span class="n">key</span><span class="p">,</span> <span class="n">adaptive_smc_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">adaptive_smc_initial_state</span> <span class="o">=</span> <span class="n">adaptive_smc_sampler</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">initial_particles</span><span class="p">)</span>
<span class="n">adaptive_smc_n_iter</span><span class="p">,</span> <span class="n">adaptive_smc_final_state</span> <span class="o">=</span> <span class="n">adaptive_schedule_loop</span><span class="p">(</span>
    <span class="n">adaptive_smc_key</span><span class="p">,</span>
    <span class="n">adaptive_smc_sampler</span><span class="p">,</span>
    <span class="n">smc_cond</span><span class="p">,</span>
    <span class="n">adaptive_smc_initial_state</span><span class="p">,</span>
    <span class="n">max_iterations</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">adaptive_smc_final_weights</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">adaptive_smc_final_state</span><span class="o">.</span><span class="n">weights</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">adaptive_smc_final_state</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of iterations (Adaptive SMC):&quot;</span><span class="p">,</span> <span class="n">adaptive_smc_n_iter</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Final ESS (Adaptive SMC): </span><span class="si">{</span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">adaptive_smc_final_weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of iterations (Adaptive SMC): 18
Final ESS (Adaptive SMC): 9808.74 

CPU times: user 4.94 s, sys: 1.39 s, total: 6.33 s
Wall time: 1.96 s
</pre></div>
</div>
</div>
</div>
</section>
<section id="adaptive-persistent-sampling">
<h2>Adaptive Persistent Sampling<a class="headerlink" href="#adaptive-persistent-sampling" title="Link to this heading">#</a></h2>
<p>The adaptive Persistent Sampling algorithm works similar to the adaptive SMC algorithm. However, there are a few noteworthy percularities:</p>
<ul class="simple">
<li><p>Since the arrays for storing the persistent ensemble need to be preallocated, the max_iterations parameter is a requirement. The arrays get padded to the shape (<code class="docutils literal notranslate"><span class="pre">max_iternations</span></code> + 1, n_particles). Therefore a large value for <code class="docutils literal notranslate"><span class="pre">max_iterations</span></code> can lead to high memory usage. Note that there is no internal check for the sampler if the max iterations are exceeded, the values will simply be written to the last available spot in the preallocated array. One should therefore include a check in the inference loop condition.</p></li>
<li><p>The target ESS for Persistent Sampling can exceed 1, since we work with a larger ensemble of particles.</p></li>
<li><p>In principle, the inference loop can be continued even when the tempering parameter reaches 1. Additional iterations can be used to increase the ESS until a desired value is reached.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">target_ess</span> <span class="o">=</span> <span class="mf">5.0</span>  <span class="c1"># PS can use ESS &gt; 1</span>

<span class="c1"># Adaptive Persistent Sampling</span>
<span class="n">adaptive_ps_sampler</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">adaptive_persistent_sampling_smc</span><span class="p">(</span>
    <span class="n">log_prior_fn</span><span class="p">,</span>
    <span class="n">log_likelihood_fn</span><span class="p">,</span>
    <span class="n">max_iterations</span><span class="p">,</span>  <span class="c1"># To define the size of the persistent arrays</span>
    <span class="n">blackjax</span><span class="o">.</span><span class="n">hmc</span><span class="o">.</span><span class="n">build_kernel</span><span class="p">(),</span>
    <span class="n">blackjax</span><span class="o">.</span><span class="n">hmc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="n">extend_params</span><span class="p">(</span><span class="n">hmc_parameters</span><span class="p">),</span>
    <span class="n">resampling</span><span class="o">.</span><span class="n">systematic</span><span class="p">,</span>
    <span class="n">target_ess</span><span class="o">=</span><span class="n">target_ess</span><span class="p">,</span>
    <span class="n">num_mcmc_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Define condition function for Adaptive PS</span>
<span class="c1"># We allow the loop to continue after lambda=1.0 if the ESS is below the target</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ps_cond</span><span class="p">(</span><span class="n">carry</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns True while lambda &lt; 1.0 or ESS &lt; target_ess and iteration &lt; max_iterations.&quot;&quot;&quot;</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">carry</span>
    <span class="n">ess</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">persistent_sampling</span><span class="o">.</span><span class="n">compute_persistent_ess</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">persistent_weights</span><span class="p">),</span> <span class="n">normalize_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">tempering_param</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">ess</span> <span class="o">&lt;</span> <span class="n">target_ess</span><span class="o">*</span><span class="n">num_particles</span><span class="p">),</span>
        <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_iterations</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Run Adaptive PS</span>
<span class="n">key</span><span class="p">,</span> <span class="n">adaptive_ps_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">adaptive_ps_initial_state</span> <span class="o">=</span> <span class="n">adaptive_ps_sampler</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">initial_particles</span><span class="p">)</span>
<span class="n">adaptive_ps_n_iter</span><span class="p">,</span> <span class="n">adaptive_ps_final_state</span> <span class="o">=</span> <span class="n">adaptive_schedule_loop</span><span class="p">(</span>
    <span class="n">adaptive_ps_key</span><span class="p">,</span>
    <span class="n">adaptive_ps_sampler</span><span class="p">,</span>
    <span class="n">ps_cond</span><span class="p">,</span>
    <span class="n">adaptive_ps_initial_state</span><span class="p">,</span>
    <span class="n">max_iterations</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># remove excess padding</span>
<span class="n">adaptive_ps_final_state</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">persistent_sampling</span><span class="o">.</span><span class="n">remove_padding</span><span class="p">(</span>
    <span class="n">adaptive_ps_final_state</span><span class="p">)</span>

<span class="n">adaptive_ps_final_weights</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">adaptive_ps_final_state</span><span class="o">.</span><span class="n">persistent_weights</span>
    <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">adaptive_ps_final_state</span><span class="o">.</span><span class="n">persistent_weights</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of iterations (Adaptive PS):&quot;</span><span class="p">,</span> <span class="n">adaptive_ps_n_iter</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final ESS (Adaptive PS): </span><span class="si">{</span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">adaptive_ps_final_weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of iterations (Adaptive PS): 5
Final ESS (Adaptive PS): 55378.03 

CPU times: user 6.5 s, sys: 1.19 s, total: 7.68 s
Wall time: 3.14 s
</pre></div>
</div>
</div>
</div>
</section>
<section id="posterior-comparison">
<h2>9. Posterior Comparison<a class="headerlink" href="#posterior-comparison" title="Link to this heading">#</a></h2>
<p>Compare the posterior samples from all four algorithms.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate true distribution for plotting</span>
<span class="n">x_linspace</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">true_distribution</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_posterior_fn</span><span class="p">(</span><span class="n">x_linspace</span><span class="p">))</span>
<span class="n">true_distribution</span> <span class="o">/=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">true_distribution</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_linspace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_linspace</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">algorithms</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;Sequential Monte Carlo&quot;</span><span class="p">,</span> <span class="n">smc_final_state</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Persistent Sampling&quot;</span><span class="p">,</span> <span class="n">ps_final_state</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Adaptive SMC&quot;</span><span class="p">,</span> <span class="n">adaptive_smc_final_state</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Adaptive PS&quot;</span><span class="p">,</span> <span class="n">adaptive_ps_final_state</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">particles</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">x_linspace</span><span class="p">,</span>
        <span class="n">true_distribution</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True Distribution&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">particles</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Samples&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.6</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Posterior Samples Comparison&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.00</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d18e94d32e10ef11fd35dec56dc53bd48f4098662891f495b64b2f4f523721b4.png" src="../_images/d18e94d32e10ef11fd35dec56dc53bd48f4098662891f495b64b2f4f523721b4.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./algorithms"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="TemperedSMCWithOptimizedInnerKernel.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Tuning inner kernel parameters of SMC</p>
      </div>
    </a>
    <a class="right-next"
       href="mclmc.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Microcanonical Langevin Monte Carlo</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sequential-monte-carlo-smc">Sequential Monte Carlo (SMC)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#persistent-sampling-ps">Persistent Sampling (PS)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-and-settings">Imports and Settings</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experimental-setup">Experimental Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#smc-with-fixed-schedule">SMC with Fixed Schedule</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#persistent-sampling-with-fixed-schedule">Persistent Sampling with Fixed Schedule</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-smc">Adaptive SMC</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-persistent-sampling">Adaptive Persistent Sampling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#posterior-comparison">9. Posterior Comparison</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Blackjax Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>