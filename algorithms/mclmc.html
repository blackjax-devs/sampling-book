
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Microcanonical Langevin Monte Carlo &#8212; The Sampling Book Project</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'algorithms/mclmc';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Change of Variable in HMC" href="../models/change_of_variable_hmc.html" />
    <link rel="prev" title="Comparing SMC and Persistent Sampling" href="SMCvsPersistentSampling.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">The Sampling Book Project</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    The Sampling Book Project
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Algorithms</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="contour_sgld.html">Contour stochastic gradient Langevin dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="cyclical_sgld.html">Cyclical SGLD</a></li>
<li class="toctree-l1"><a class="reference internal" href="pathfinder.html">Pathfinder</a></li>
<li class="toctree-l1"><a class="reference internal" href="PeriodicOrbitalMCMC.html">Periodic Orbital MCMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="TemperedSMC.html">Use Tempered SMC to Improve Exploration of MCMC Methods.</a></li>
<li class="toctree-l1"><a class="reference internal" href="TemperedSMCWithOptimizedInnerKernel.html">Tuning inner kernel parameters of SMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="SMCvsPersistentSampling.html">Comparing SMC and Persistent Sampling</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Microcanonical Langevin Monte Carlo</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Models</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../models/change_of_variable_hmc.html">Change of Variable in HMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/GP_EllipticalSliceSampler.html">Gaussian Regression with the Elliptical Slice Sampler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/GP_Marginal.html">Bayesian Regression With Latent Gaussian Sampler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/sparse_regression.html">Sparse regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/logistic_regression.html">Bayesian Logistic Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/LogisticRegressionWithLatentGaussianSampler.html">Bayesian Logistic Regression With Latent Gaussian Sampler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/mlp.html">MLP classifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/hierarchical_bnn.html">Hierarchical Bayesian Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/RegimeSwitchingModel.html">Regime switching Hidden Markov model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/probabilistic_ode_solver_parameter_estimation.html">Parameter estimation in ODE models with a probabilistic ODE solver</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/blackjax-devs/sampling-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/blackjax-devs/sampling-book/issues/new?title=Issue%20on%20page%20%2Falgorithms/mclmc.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/algorithms/mclmc.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Microcanonical Langevin Monte Carlo</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Microcanonical Langevin Monte Carlo</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-run-mclmc-in-blackjax">How to run MCLMC in BlackJax</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-analyze-the-results-of-your-mclmc-run">How to analyze the results of your MCLMC run</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#validate-the-choice-of-epsilon">Validate the choice of <span class="math notranslate nohighlight">\(\epsilon\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-more-complex-example">A more complex example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adjusted-mclmc">Adjusted MCLMC</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="microcanonical-langevin-monte-carlo">
<h1>Microcanonical Langevin Monte Carlo<a class="headerlink" href="#microcanonical-langevin-monte-carlo" title="Link to this heading">#</a></h1>
<p>This is an algorithm based on <a class="reference external" href="https://www.jmlr.org/papers/volume24/22-1450/22-1450.pdf">MCHMC</a> and <a class="reference external" href="https://proceedings.mlr.press/v253/robnik24a.html">MCLMC</a> papers. A website with detailed information can be found <a class="reference external" href="https://microcanonical-monte-carlo.netlify.app/">here</a>.</p>
<!-- The algorithm is provided in both adjusted (i.e. with an Metropolis-Hastings step) and unadjusted versions; by default we use "MCLMC" to refer to the unadjusted version. -->
<p>The idea is that we have a distribution <span class="math notranslate nohighlight">\(p(x)\)</span> from which we want to sample. We numerically integrate the following SDE; the samples we obtain converge (in the limit of many steps and small step size) to samples from the target distribution.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\frac{d}{dt}\begin{bmatrix}
x \\
u
\end{bmatrix}
=
\begin{bmatrix}
u \\
-P(u)(\nabla S(x)/(d − 1)) + \eta P(u)dW
\end{bmatrix}
\end{split}\]</div>
<p>Here <span class="math notranslate nohighlight">\(x \in \mathbb{R}^n\)</span> is the variable of interest (i.e. the variable of the target distribution <span class="math notranslate nohighlight">\(p\)</span>), <span class="math notranslate nohighlight">\(u \in \mathbb{S}^{n-1}\)</span> is the momentum (i.e. <span class="math notranslate nohighlight">\(u\)</span> lives in <span class="math notranslate nohighlight">\(\mathbb{R}^n\)</span> but is constrained to have fixed norm), <span class="math notranslate nohighlight">\(S(x)\)</span> is the negative log PDF of the distribution from which we are sampling, and <span class="math notranslate nohighlight">\(P(u)=(I-uu^T)\)</span> is the projection operator. The term <span class="math notranslate nohighlight">\(\eta P(u)dW\)</span> describes spherically symmetric noise on the <span class="math notranslate nohighlight">\(n-1\)</span> sphere <span class="math notranslate nohighlight">\(\mathbb{S}^{n-1}\)</span>. After <span class="math notranslate nohighlight">\(u\)</span> is marginalized out, this converges to the target PDF, <span class="math notranslate nohighlight">\(p(x) \propto e^{-S(x)}\)</span>.</p>
<section id="how-to-run-mclmc-in-blackjax">
<h2>How to run MCLMC in BlackJax<a class="headerlink" href="#how-to-run-mclmc-in-blackjax" title="Link to this heading">#</a></h2>
<p>MCLMC has two parameters:</p>
<ul class="simple">
<li><p>Typical momentum decoherence scale <span class="math notranslate nohighlight">\(L\)</span>. This adds some noise to the direction of the velocity after every step. <span class="math notranslate nohighlight">\(L = \infty\)</span> means no noise, <span class="math notranslate nohighlight">\(L = 0\)</span> is full refreshement after every step.</p></li>
<li><p>Stepsize <span class="math notranslate nohighlight">\(\epsilon\)</span> of the discretization of the dynamics. While the continuous dynamics converge exactly on the target distribution, the discrete dynamics inject bias into the resulting distribution. As such, we want to find the ideal tradeoff: <span class="math notranslate nohighlight">\(\epsilon\)</span> small enough for bias to be minimal, but large enough for computational efficiency.</p></li>
</ul>
<p>MCLMC in Blackjax comes with a tuning algorithm which attempts to find optimal values for both of these parameters. This must be used for good performance.</p>
<p>An example is given below, of tuning and running a chain for a 1000 dimensional Gaussian target (of which a 2 dimensional marginal is plotted):</p>
<div class="cell tag_hide-cell docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell content</p>
<p class="expanded admonition-title">Hide code cell content</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.spines.right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.spines.top&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">19</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">blackjax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpyro</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpyro.distributions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dist</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">numpyro.infer.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">initialize_model</span>

<span class="n">rng_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.11.11/x64/lib/python3.11/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run_mclmc</span><span class="p">(</span><span class="n">logdensity_fn</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">initial_position</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">desired_energy_variance</span><span class="o">=</span> <span class="mf">5e-4</span><span class="p">):</span>
    <span class="n">init_key</span><span class="p">,</span> <span class="n">tune_key</span><span class="p">,</span> <span class="n">run_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># create an initial state for the sampler</span>
    <span class="n">initial_state</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">mclmc</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
        <span class="n">position</span><span class="o">=</span><span class="n">initial_position</span><span class="p">,</span> <span class="n">logdensity_fn</span><span class="o">=</span><span class="n">logdensity_fn</span><span class="p">,</span> <span class="n">rng_key</span><span class="o">=</span><span class="n">init_key</span>
    <span class="p">)</span>

    <span class="c1"># build the kernel</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">inverse_mass_matrix</span> <span class="p">:</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">mclmc</span><span class="o">.</span><span class="n">build_kernel</span><span class="p">(</span>
        <span class="n">logdensity_fn</span><span class="o">=</span><span class="n">logdensity_fn</span><span class="p">,</span>
        <span class="n">integrator</span><span class="o">=</span><span class="n">blackjax</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">isokinetic_mclachlan</span><span class="p">,</span>
        <span class="n">inverse_mass_matrix</span><span class="o">=</span><span class="n">inverse_mass_matrix</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># find values for L and step_size</span>
    <span class="p">(</span>
        <span class="n">blackjax_state_after_tuning</span><span class="p">,</span>
        <span class="n">blackjax_mclmc_sampler_params</span><span class="p">,</span>
        <span class="n">_</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">mclmc_find_L_and_step_size</span><span class="p">(</span>
        <span class="n">mclmc_kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">,</span>
        <span class="n">state</span><span class="o">=</span><span class="n">initial_state</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="o">=</span><span class="n">tune_key</span><span class="p">,</span>
        <span class="n">diagonal_preconditioning</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">desired_energy_var</span><span class="o">=</span><span class="n">desired_energy_variance</span>
    <span class="p">)</span>

    <span class="c1"># use the quick wrapper to build a new kernel with the tuned parameters</span>
    <span class="n">sampling_alg</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">mclmc</span><span class="p">(</span>
        <span class="n">logdensity_fn</span><span class="p">,</span>
        <span class="n">L</span><span class="o">=</span><span class="n">blackjax_mclmc_sampler_params</span><span class="o">.</span><span class="n">L</span><span class="p">,</span>
        <span class="n">step_size</span><span class="o">=</span><span class="n">blackjax_mclmc_sampler_params</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># run the sampler</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">run_inference_algorithm</span><span class="p">(</span>
        <span class="n">rng_key</span><span class="o">=</span><span class="n">run_key</span><span class="p">,</span>
        <span class="n">initial_state</span><span class="o">=</span><span class="n">blackjax_state_after_tuning</span><span class="p">,</span>
        <span class="n">inference_algorithm</span><span class="o">=</span><span class="n">sampling_alg</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
        <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">samples</span><span class="p">,</span> <span class="n">blackjax_state_after_tuning</span><span class="p">,</span> <span class="n">blackjax_mclmc_sampler_params</span><span class="p">,</span> <span class="n">run_key</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run the algorithm on a high dimensional gaussian, and show two of the dimensions</span>

<span class="n">logdensity_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">num_steps</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">position</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>


<span class="n">sample_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
<span class="n">samples</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">chain_key</span> <span class="o">=</span> <span class="n">run_mclmc</span><span class="p">(</span>
    <span class="n">logdensity_fn</span><span class="o">=</span><span class="n">logdensity_fn</span><span class="p">,</span>
    <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">,</span>
    <span class="n">initial_position</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1000</span><span class="p">,)),</span>
    <span class="n">key</span><span class="o">=</span><span class="n">sample_key</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">samples</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='10000' class='' max='10000' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [10000/10000 00:00&lt;?]
    </div>
    </div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Array(-0.00095896, dtype=float32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Scatter Plot of Samples&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Scatter Plot of Samples&#39;)
</pre></div>
</div>
<img alt="../_images/e05d315cacbf5fee794a240e7e49e1cf634791f1d1aa5193825d849b9fd53861.png" src="../_images/e05d315cacbf5fee794a240e7e49e1cf634791f1d1aa5193825d849b9fd53861.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">visualize_results_gauss</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
  <span class="n">x1</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span> <span class="n">label</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ground_truth_gauss</span><span class="p">():</span>
  <span class="c1"># ground truth</span>
  <span class="n">t</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span>  <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span> <span class="s1">&#39;exact&#39;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x_1$&#39;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$p(x_1$)&#39;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">visualize_results_gauss</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="s1">&#39;MCLMC&#39;</span><span class="p">,</span> <span class="s1">&#39;teal&#39;</span><span class="p">)</span>
<span class="n">ground_truth_gauss</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b3770709ae8c895d80ab796efba58c6aa0e2fed972295a40abb86d28abe337f5.png" src="../_images/b3770709ae8c895d80ab796efba58c6aa0e2fed972295a40abb86d28abe337f5.png" />
</div>
</div>
<p>Note that the number of samples is relatively large compared to the number of samples typically used by say NUTS. This is because for MCLMC each sample corresponds to one integration step, while for NUTS each sample corresponds to multiple integration steps (typically to up to 1024). What determines the runtime is the number of integration steps, not the number of samples.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="how-to-analyze-the-results-of-your-mclmc-run">
<h1>How to analyze the results of your MCLMC run<a class="headerlink" href="#how-to-analyze-the-results-of-your-mclmc-run" title="Link to this heading">#</a></h1>
<section id="validate-the-choice-of-epsilon">
<h2>Validate the choice of <span class="math notranslate nohighlight">\(\epsilon\)</span><a class="headerlink" href="#validate-the-choice-of-epsilon" title="Link to this heading">#</a></h2>
<p>A natural sanity check is to see if reducing <span class="math notranslate nohighlight">\(\epsilon\)</span> changes the inferred distribution to an extent you care about. For example, we can inspect the 1D marginal with a stepsize <span class="math notranslate nohighlight">\(\epsilon\)</span> as above, and compare it to a stepsize <span class="math notranslate nohighlight">\(\epsilon/2\)</span> (and double the number of steps). We show this comparison below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">step_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">new_num_steps</span> <span class="o">=</span> <span class="n">num_steps</span> <span class="o">*</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sampling_alg</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">mclmc</span><span class="p">(</span>
    <span class="n">logdensity_fn</span><span class="p">,</span>
    <span class="n">L</span><span class="o">=</span><span class="n">new_params</span><span class="o">.</span><span class="n">L</span><span class="p">,</span>
    <span class="n">step_size</span><span class="o">=</span><span class="n">new_params</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># run the sampler</span>
<span class="n">_</span><span class="p">,</span> <span class="n">new_samples</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">run_inference_algorithm</span><span class="p">(</span>
    <span class="n">rng_key</span><span class="o">=</span> <span class="n">chain_key</span><span class="p">,</span>
    <span class="n">initial_state</span><span class="o">=</span><span class="n">initial_state</span><span class="p">,</span>
    <span class="n">inference_algorithm</span><span class="o">=</span><span class="n">sampling_alg</span><span class="p">,</span>
    <span class="n">num_steps</span><span class="o">=</span><span class="n">new_num_steps</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
    <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">visualize_results_gauss</span><span class="p">(</span><span class="n">new_samples</span><span class="p">,</span> <span class="s1">&#39;MCLMC&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">visualize_results_gauss</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="s1">&#39;MCLMC&#39;</span><span class="p">,</span> <span class="s1">&#39;teal&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='20000' class='' max='20000' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [20000/20000 00:00&lt;?]
    </div>
    </div><img alt="../_images/5f1560193bad33e8a5b6184f24bdaf0087e2547890801de70e7af418c8caf442.png" src="../_images/5f1560193bad33e8a5b6184f24bdaf0087e2547890801de70e7af418c8caf442.png" />
</div>
</div>
<p>So here the change has little effect in this case.</p>
</section>
<section id="a-more-complex-example">
<h2>A more complex example<a class="headerlink" href="#a-more-complex-example" title="Link to this heading">#</a></h2>
<p>We now consider a more complex model, of stock volatility.</p>
<p>The returns <span class="math notranslate nohighlight">\(r_n\)</span> are modeled by a Student’s-t distribution whose scale (volatility) <span class="math notranslate nohighlight">\(R_n\)</span> is time varying and unknown. The prior for <span class="math notranslate nohighlight">\(\log R_n\)</span> is a Gaussian random walk, with an exponential distribution of the random walk step-size <span class="math notranslate nohighlight">\(\sigma\)</span>. An exponential prior is also taken for the Student’s-t degrees of freedom <span class="math notranslate nohighlight">\(\nu\)</span>. The generative process of the data is:</p>
<div class="amsmath math notranslate nohighlight" id="equation-e8ac9bfc-a47c-4995-96bd-5e299477ebbe">
<span class="eqno">(1)<a class="headerlink" href="#equation-e8ac9bfc-a47c-4995-96bd-5e299477ebbe" title="Permalink to this equation">#</a></span>\[\begin{align}
    &amp;r_n / R_n \sim \text{Student's-t}(\nu) \qquad
    &amp;&amp;\nu \sim \text{Exp}(\lambda = 1/10) \\ \nonumber
    &amp;\log R_n \sim \mathcal{N}(\log R_{n-1}, \sigma) \qquad
    &amp;&amp;\sigma \sim \text{Exp}(\lambda = 1/0.02).
\end{align}\]</div>
<p>Our task is to find the posterior of the parameters <span class="math notranslate nohighlight">\(\{R_n\}_{n =1}^N\)</span>, <span class="math notranslate nohighlight">\(\sigma\)</span> and <span class="math notranslate nohighlight">\(\nu\)</span>, given the observed data <span class="math notranslate nohighlight">\(\{r_n\}_{n =1}^N\)</span>.</p>
<p>First, we get the data, define a model using NumPyro, and draw samples:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpyro.examples.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">SP500</span><span class="p">,</span> <span class="n">load_dataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpyro.distributions</span><span class="w"> </span><span class="kn">import</span> <span class="n">StudentT</span>

<span class="c1"># get the data</span>
<span class="n">_</span><span class="p">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">SP500</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SP500_dates</span><span class="p">,</span> <span class="n">SP500_returns</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">()</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">datestr2num</span><span class="p">(</span><span class="n">SP500_dates</span><span class="p">))</span>



<span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">():</span>
  <span class="c1"># figure setup,</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
  <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">()</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#remove the upper and the right axis lines</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

  <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">YearLocator</span><span class="p">())</span> <span class="c1">#dates on the xaxis</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">))</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">MonthLocator</span><span class="p">())</span>

  <span class="c1"># plot data</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">SP500_returns</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span> <span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;S&amp;P500 returns&#39;</span><span class="p">)</span>


<span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading - https://d2hg8soec8ck9v.cloudfront.net/datasets/SP500.csv.
Download complete.
</pre></div>
</div>
<img alt="../_images/007875a6641d5f45dcd208adcadda104db098d0a2c3a6adc8ab9a549a3ea8194.png" src="../_images/007875a6641d5f45dcd208adcadda104db098d0a2c3a6adc8ab9a549a3ea8194.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">from_numpyro</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">,</span> <span class="n">model_args</span><span class="p">):</span>
  <span class="n">init_params</span><span class="p">,</span> <span class="n">potential_fn_gen</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">initialize_model</span><span class="p">(</span>
      <span class="n">rng_key</span><span class="p">,</span>
      <span class="n">model</span><span class="p">,</span>
      <span class="n">model_args</span><span class="o">=</span> <span class="n">model_args</span><span class="p">,</span>
      <span class="n">dynamic_args</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="n">logdensity_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">position</span><span class="p">:</span> <span class="o">-</span><span class="n">potential_fn_gen</span><span class="p">(</span><span class="o">*</span><span class="n">model_args</span><span class="p">)(</span><span class="n">position</span><span class="p">)</span>
  <span class="n">initial_position</span> <span class="o">=</span> <span class="n">init_params</span><span class="o">.</span><span class="n">z</span>

  <span class="k">return</span> <span class="n">logdensity_fn</span><span class="p">,</span> <span class="n">initial_position</span>


<span class="k">def</span><span class="w"> </span><span class="nf">stochastic_volatility</span><span class="p">(</span><span class="n">sigma_mean</span><span class="p">,</span> <span class="n">nu_mean</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;numpyro model&quot;&quot;&quot;</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">sigma_mean</span><span class="p">))</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;nu&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">nu_mean</span><span class="p">))</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">GaussianRandomWalk</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">SP500_returns</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span> <span class="c1"># = log R</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">StudentT</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">nu</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">s</span><span class="p">)),</span> <span class="n">obs</span><span class="o">=</span> <span class="n">SP500_returns</span><span class="p">)</span>


<span class="n">model_args</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span>
<span class="n">rng_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">logp_sv</span><span class="p">,</span> <span class="n">x_init</span> <span class="o">=</span> <span class="n">from_numpyro</span><span class="p">(</span><span class="n">stochastic_volatility</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">,</span> <span class="n">model_args</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_steps</span> <span class="o">=</span> <span class="mi">20000</span>

<span class="n">samples</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">chain_key</span> <span class="o">=</span> <span class="n">run_mclmc</span><span class="p">(</span><span class="n">logdensity_fn</span><span class="o">=</span> <span class="n">logp_sv</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">initial_position</span><span class="o">=</span> <span class="n">x_init</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span> <span class="n">sample_key</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">visualize_results_sv</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>

  <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]))</span> <span class="c1"># take an exponent to get R</span>
  <span class="n">lower_quantile</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">upper_quantile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

  <span class="c1"># plot posterior</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">lower_quantile</span><span class="p">,</span> <span class="n">upper_quantile</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span> <span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>


<span class="n">setup</span><span class="p">()</span>

<span class="n">visualize_results_sv</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span> <span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span> <span class="s1">&#39;volatility posterior&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='20000' class='' max='20000' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [20000/20000 00:00&lt;?]
    </div>
    </div><img alt="../_images/293756abcc399785fe148a687e7f518ac73e22607a8c69d82d632bafdd0eda40.png" src="../_images/293756abcc399785fe148a687e7f518ac73e22607a8c69d82d632bafdd0eda40.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">step_size</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">step_size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">new_num_steps</span> <span class="o">=</span> <span class="n">num_steps</span> <span class="o">*</span> <span class="mi">2</span>

<span class="n">sampling_alg</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">mclmc</span><span class="p">(</span>
    <span class="n">logp_sv</span><span class="p">,</span>
    <span class="n">L</span><span class="o">=</span><span class="n">new_params</span><span class="o">.</span><span class="n">L</span><span class="p">,</span>
    <span class="n">step_size</span><span class="o">=</span><span class="n">new_params</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span>
<span class="p">)</span>



<span class="c1"># # run the sampler</span>
<span class="n">_</span><span class="p">,</span> <span class="n">new_samples</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">run_inference_algorithm</span><span class="p">(</span>
    <span class="n">rng_key</span><span class="o">=</span><span class="n">chain_key</span><span class="p">,</span>
    <span class="n">initial_state</span><span class="o">=</span><span class="n">initial_state</span><span class="p">,</span>
    <span class="n">inference_algorithm</span><span class="o">=</span><span class="n">sampling_alg</span><span class="p">,</span>
    <span class="n">num_steps</span><span class="o">=</span><span class="n">new_num_steps</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">info</span> <span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
    <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">()</span>
<span class="n">visualize_results_sv</span><span class="p">(</span><span class="n">new_samples</span><span class="p">,</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;MCLMC&#39;</span><span class="p">,</span> <span class="p">)</span>
<span class="n">visualize_results_sv</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span><span class="s1">&#39;teal&#39;</span><span class="p">,</span> <span class="s1">&#39;MCLMC (stepsize/2)&#39;</span><span class="p">,</span> <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='40000' class='' max='40000' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [40000/40000 00:00&lt;?]
    </div>
    </div><img alt="../_images/2df14b5ac282d02100f25c36ad312b71b1e2babe915653b1abdec3e8bf10f17c.png" src="../_images/2df14b5ac282d02100f25c36ad312b71b1e2babe915653b1abdec3e8bf10f17c.png" />
</div>
</div>
<p>Here, we have again inspected the effect of halving <span class="math notranslate nohighlight">\(\epsilon\)</span>. This looks OK, but suppose we are interested in the hierarchial parameters in particular, which tend to be harder to infer. We now inspect the marginal of a hierarchical parameter:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">visualize_results_sv_marginal</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="c1"># plt.subplot(1, 2, 1)</span>
    <span class="c1"># plt.hist(samples[&#39;nu&#39;], bins = 20, histtype= &#39;step&#39;, lw= 4, density= True, color= color, label= label)</span>
    <span class="c1"># plt.xlabel(r&#39;$\nu$&#39;)</span>
    <span class="c1"># plt.ylabel(r&#39;$p(\nu \vert \mathrm{data})$&#39;)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">],</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span> <span class="n">label</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$p(\sigma \vert \mathrm</span><span class="si">{data}</span><span class="s1">)$&#39;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">visualize_results_sv_marginal</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span> <span class="s1">&#39;teal&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span> <span class="s1">&#39;MCLMC&#39;</span><span class="p">)</span>
<span class="n">visualize_results_sv_marginal</span><span class="p">(</span><span class="n">new_samples</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span> <span class="s1">&#39;MCLMC (stepsize/2)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1be69405944991938c40328f619e1b1df5b317307b082dd7891c1711159fa4ff.png" src="../_images/1be69405944991938c40328f619e1b1df5b317307b082dd7891c1711159fa4ff.png" />
</div>
</div>
<p>If we care about this parameter in particular, we should reduce step size further, until the difference disappears.</p>
</section>
<section id="adjusted-mclmc">
<h2>Adjusted MCLMC<a class="headerlink" href="#adjusted-mclmc" title="Link to this heading">#</a></h2>
<p>Blackjax also provides an adjusted version of the algorithm, based on <a class="reference external" href="https://neurips.cc/virtual/2025/poster/117452">this</a> paper. This also has two hyperparameters, <code class="docutils literal notranslate"><span class="pre">step_size</span></code> and <code class="docutils literal notranslate"><span class="pre">L</span></code>. <code class="docutils literal notranslate"><span class="pre">L</span></code> is related to the <code class="docutils literal notranslate"><span class="pre">L</span></code> parameter of the unadjusted version, but not identical (It determines the length of a proposal, and since momentum is resampled after a proposal, length of proposal determines the momentum decoherence rate). It is also possible to have Langevin noise during the trajectory, although we don’t see improvements here.</p>
<p>The tuning algorithm is also similar, but uses a dual averaging scheme to tune the step size. We find in practice that a target MH acceptance rate of 0.9 is a good choice.</p>
<p><strong>Our recommendation is to use the unadjusted version when possible</strong>, but if you really believe you need the algorithm to be asymptotically unbiased (it’s not obvious why you would), you should use the adjusted version, with mass matrix preconditioning, randomized trajectory length and no in-proposal Langevin noise. We encapsulate these best practices in <code class="docutils literal notranslate"><span class="pre">run_adjusted_mcmc</span></code> below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">blackjax.mcmc.adjusted_mclmc_dynamic</span><span class="w"> </span><span class="kn">import</span> <span class="n">rescale</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">blackjax.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_inference_algorithm</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_adjusted_mclmc_dynamic</span><span class="p">(</span>
    <span class="n">logdensity_fn</span><span class="p">,</span>
    <span class="n">num_steps</span><span class="p">,</span>
    <span class="n">initial_position</span><span class="p">,</span>
    <span class="n">key</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">_</span> <span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
    <span class="n">diagonal_preconditioning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">random_trajectory_length</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">L_proposal_factor</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">inf</span>
<span class="p">):</span>

    <span class="n">init_key</span><span class="p">,</span> <span class="n">tune_key</span><span class="p">,</span> <span class="n">run_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">initial_state</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">adjusted_mclmc_dynamic</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
        <span class="n">position</span><span class="o">=</span><span class="n">initial_position</span><span class="p">,</span>
        <span class="n">logdensity_fn</span><span class="o">=</span><span class="n">logdensity_fn</span><span class="p">,</span>
        <span class="n">random_generator_arg</span><span class="o">=</span><span class="n">init_key</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">random_trajectory_length</span><span class="p">:</span>
        <span class="n">integration_steps_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">avg_num_integration_steps</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
            <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">rescale</span><span class="p">(</span><span class="n">avg_num_integration_steps</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">integration_steps_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">avg_num_integration_steps</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">avg_num_integration_steps</span><span class="p">)</span>

    <span class="n">kernel</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rng_key</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">avg_num_integration_steps</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">inverse_mass_matrix</span><span class="p">:</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">adjusted_mclmc_dynamic</span><span class="o">.</span><span class="n">build_kernel</span><span class="p">(</span>
        <span class="n">integration_steps_fn</span><span class="o">=</span><span class="n">integration_steps_fn</span><span class="p">(</span><span class="n">avg_num_integration_steps</span><span class="p">),</span>
        <span class="n">inverse_mass_matrix</span><span class="o">=</span><span class="n">inverse_mass_matrix</span><span class="p">,</span>
    <span class="p">)(</span>
        <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
        <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
        <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span>
        <span class="n">logdensity_fn</span><span class="o">=</span><span class="n">logdensity_fn</span><span class="p">,</span>
        <span class="n">L_proposal_factor</span><span class="o">=</span><span class="n">L_proposal_factor</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">target_acc_rate</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="c1"># our recommendation</span>

    <span class="p">(</span>
        <span class="n">blackjax_state_after_tuning</span><span class="p">,</span>
        <span class="n">blackjax_mclmc_sampler_params</span><span class="p">,</span>
        <span class="n">_</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">adjusted_mclmc_find_L_and_step_size</span><span class="p">(</span>
        <span class="n">mclmc_kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">,</span>
        <span class="n">state</span><span class="o">=</span><span class="n">initial_state</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="o">=</span><span class="n">tune_key</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">target_acc_rate</span><span class="p">,</span>
        <span class="n">frac_tune1</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">frac_tune2</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">frac_tune3</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="c1"># our recommendation</span>
        <span class="n">diagonal_preconditioning</span><span class="o">=</span><span class="n">diagonal_preconditioning</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">step_size</span> <span class="o">=</span> <span class="n">blackjax_mclmc_sampler_params</span><span class="o">.</span><span class="n">step_size</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">blackjax_mclmc_sampler_params</span><span class="o">.</span><span class="n">L</span>

    <span class="n">alg</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">adjusted_mclmc_dynamic</span><span class="p">(</span>
        <span class="n">logdensity_fn</span><span class="o">=</span><span class="n">logdensity_fn</span><span class="p">,</span>
        <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span>
        <span class="n">integration_steps_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
            <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">*</span> <span class="n">rescale</span><span class="p">(</span><span class="n">L</span> <span class="o">/</span> <span class="n">step_size</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">inverse_mass_matrix</span><span class="o">=</span><span class="n">blackjax_mclmc_sampler_params</span><span class="o">.</span><span class="n">inverse_mass_matrix</span><span class="p">,</span>
        <span class="n">L_proposal_factor</span><span class="o">=</span><span class="n">L_proposal_factor</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">run_inference_algorithm</span><span class="p">(</span>
        <span class="n">rng_key</span><span class="o">=</span><span class="n">run_key</span><span class="p">,</span>
        <span class="n">initial_state</span><span class="o">=</span><span class="n">blackjax_state_after_tuning</span><span class="p">,</span>
        <span class="n">inference_algorithm</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
        <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run the algorithm on a high dimensional gaussian, and show two of the dimensions</span>

<span class="n">sample_key</span><span class="p">,</span> <span class="n">rng_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">run_adjusted_mclmc_dynamic</span><span class="p">(</span>
    <span class="n">logdensity_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
    <span class="n">num_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">initial_position</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1000</span><span class="p">,)),</span>
    <span class="n">key</span><span class="o">=</span><span class="n">sample_key</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Scatter Plot of Samples&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Scatter Plot of Samples&#39;)
</pre></div>
</div>
<img alt="../_images/9d91dd02d6709006a7570f5dce1f98137296cc76adc713f80e67d51aec0410fb.png" src="../_images/9d91dd02d6709006a7570f5dce1f98137296cc76adc713f80e67d51aec0410fb.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_steps</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="n">adjusted_samples</span> <span class="o">=</span> <span class="n">run_adjusted_mclmc_dynamic</span><span class="p">(</span><span class="n">logdensity_fn</span><span class="o">=</span> <span class="n">logp_sv</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">initial_position</span><span class="o">=</span> <span class="n">x_init</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span> <span class="n">sample_key</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">()</span>
<span class="n">visualize_results_sv</span><span class="p">(</span><span class="n">adjusted_samples</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span> <span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span> <span class="s1">&#39;volatility posterior&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b76d0fc3ca07a87d50208eb6830efd75dbb5386ebdcc834dcb67c004a326a0f5.png" src="../_images/b76d0fc3ca07a87d50208eb6830efd75dbb5386ebdcc834dcb67c004a326a0f5.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./algorithms"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="SMCvsPersistentSampling.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Comparing SMC and Persistent Sampling</p>
      </div>
    </a>
    <a class="right-next"
       href="../models/change_of_variable_hmc.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Change of Variable in HMC</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Microcanonical Langevin Monte Carlo</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-run-mclmc-in-blackjax">How to run MCLMC in BlackJax</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-analyze-the-results-of-your-mclmc-run">How to analyze the results of your MCLMC run</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#validate-the-choice-of-epsilon">Validate the choice of <span class="math notranslate nohighlight">\(\epsilon\)</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-more-complex-example">A more complex example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adjusted-mclmc">Adjusted MCLMC</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Blackjax Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>